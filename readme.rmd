
#Creating a Simple Interactive Map with R, Leaflet, and Shiny

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Getting and cleaning the data

The dataset is available in downloadable or GeoJSON format. I'm going with JSON so that the shiny app can be standalone without additional need for data management.  

Several libraries are required for this project. use the `install.packages('packagename')` command to install the libraries/packages before attempting the code to load them below

```{r libraries,eval=FALSE}

library(rgdal)
library(ggplot2)
library(maptools)
library(dplyr)
library(ggmap)
library(leaflet)
library(dplyr)
library(jsonlite)
library(tidyr)
library(curl)
```

Retrieval of the data is bit *chunky* at the moment, utilizing the ```jsonlite``` library and some cleanup code we create a usable dataset below: 

```{r json,eval=FALSE}
## Retrieve the data in JSON format from opendata.dc.gov using fromJson()
dccrimejsonlite <- fromJSON('http://opendata.dc.gov/datasets/dc3289eab3d2400ea49c154863312434_8.geojson')
## use cbind() to access the list elements and create dataframe
dc_crime_json <- cbind(dccrimejsonlite$features$properties,dccrimejsonlite$features$geometry)

## Seperate and clean lat/long columns
## --also separate REPORTDATETIME column
dc_crime_clean <- dc_crime_json %>% 
  separate(coordinates, into = c("X", "Y"), sep = ",")%>%
  separate(REPORTDATETIME, into = c("Date","Time"), sep="T")

## convert lat and long columns to numbers and remove non numeric characters
dc_crime_clean$X <- as.numeric(gsub("c\\(","",dc_crime_clean$X))
dc_crime_clean$Y <- as.numeric(gsub("\\)","",dc_crime_clean$Y))

#Create date column from datetime

dc_crime_clean$DateClean <- as.Date(dc_crime_clean$Date)

bydate <- group_by(dc_crime_clean,DateClean,OFFENSE,SHIFT)
crimedc_bydate <- summarise(bydate,
                            count=n())
```

In the above, the data is retrieved using the ```fromJSON()``` function, and the columns are retrieved using the ```cbind()``` function. 

The latitude and longitude columns are cleaned using the ```separate()``` function from library ```tidyr``` and RegEx to remove erroneous characters from the columns.

###ui.R 
```{r ui, eval=FALSE}
library(shiny)
library(shinythemes)
library(leaflet)

fluidPage(theme = shinytheme("cerulean"),
  titlePanel("<in dev> DC Crime - Last 30 Days <in dev>"),
  h3("<in dev> Map Explorer for last 30 days DC Crime Dataset <in dev>"),
  
  helpText("Data May be Delayed"),
  p(
    class="text-info",
    a("data source: http://opendata.dc.gov/datasets",href="http://opendata.dc.gov/datasets"),
    br(),
   paste("GeoJSON API url: http://opendata.dc.gov/datasets/dc3289eab3d2400ea49c154863312434_8.geojson"),
    br()
   ),
  p(
    class="text-muted",
    paste("If disconnected from server, try reloading... map is in dev with new features to be added. \n suggestions and evolutions are welcome:"),
    a("github",href="https://github.com/sampsonsimpson/DC_Crime_Data")
  ),
  p(
    class="text-primary",
    a("author: neil kutty", href="http:/twitter.com/neilkutty"),
    br(),
    a("original ui and server code", href="https://rstudio.github.io/leaflet/shiny.html")
  ),
  
  p(
    class="text-info",
    paste("Click on cluster or scroll for zoom. Click on individual marker for additional detail popup.")
  ),

  
  leafletOutput("mymap"),
  br(),
  actionButton("reset","Reset Map View")
  
 
)
```

###server.R
```{r server.R file, eval=FALSE}

library(rgdal)
library(ggplot2)
library(maptools)
library(dplyr)
library(ggmap)
library(leaflet)
library(dplyr)
library(jsonlite)
library(tidyr)
library(curl)

## Retrieve the data in JSON format from opendata.dc.gov using fromJson()
dccrimejsonlite <- fromJSON('http://opendata.dc.gov/datasets/dc3289eab3d2400ea49c154863312434_8.geojson')
## use cbind() to access the list elements and create dataframe
dc_crime_json <- cbind(dccrimejsonlite$features$properties,dccrimejsonlite$features$geometry)

## Get distinct Offenses for shiny input
offenses <- distinct(select(dc_crime_json,OFFENSE))
row.names(offenses) <- offenses$OFFENSE

## Seperate and clean lat/long columns
## --also separate REPORTDATETIME column
dc_crime_clean <- dc_crime_json %>% 
  separate(coordinates, into = c("X", "Y"), sep = ",")%>%
  separate(REPORTDATETIME, into = c("Date","Time"), sep="T")

## convert lat and long columns to numbers and remove non numeric characters
dc_crime_clean$X <- as.numeric(gsub("c\\(","",dc_crime_clean$X))
dc_crime_clean$Y <- as.numeric(gsub("\\)","",dc_crime_clean$Y))

#Create date column from datetime

dc_crime_clean$DateClean <- as.Date(dc_crime_clean$Date)

bydate <- group_by(dc_crime_clean,DateClean,OFFENSE,SHIFT)
crimedc_bydate <- summarise(bydate,
                            count=n())

########---------------------------------------------------------------------#>>>



function(input, output, session) {
  # jsonlite
  ## AUTOMATION OF DC Crime Last 30 Days Data
  ########---------------------------------------------------------------------#>>>
  
  
  points <- eventReactive(input$reset, {
    
    cbind(dc_crime_clean$X,dc_crime_clean$Y)
    
    }, ignoreNULL = FALSE)
  
  output$mymap <- renderLeaflet({
    
    leaflet() %>%
      addProviderTiles("OpenStreetMap.Mapnik",
                       options = providerTileOptions(noWrap = TRUE)
      ) %>%
      addMarkers(data = points(),popup = paste0("<strong>Report Datetime: </strong>",
                                                dc_crime_json$REPORTDATETIME,
                                                "<br><strong>Offense: </strong>", 
                                                dc_crime_json$OFFENSE, 
                                                "<br><strong>method: </strong>", 
                                                dc_crime_json$METHOD,
                                                "<br><strong>shift:</strong>",
                                                dc_crime_json$SHIFT,
                                                "<br><strong>blocksite address:</strong><br>",
                                                dc_crime_json$BLOCKSITEADDRESS
                                                ),
                 
                 clusterOptions = markerClusterOptions()
                   
                 ) 
    
  })

  }
```

#<...>